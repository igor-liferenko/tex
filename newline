#!/usr/bin/perl -w

# http://tug.org/texmfbug/nobug.html#ttynl

exit unless -t 0 && -t 1;

use POSIX ':termios_h';

$termios = POSIX::Termios->new;
$termios->getattr(0);
$c_lflag = $termios->getlflag;

$termios->setlflag($c_lflag & ~(ECHO | ICANON));
$termios->setattr(1, TCSANOW);

syswrite STDOUT, "\e[6n";
reset1:
sysread STDIN, $x, 1;
reset2:
goto reset1 if $x ne chr 0x1b;
sysread STDIN, $x, 1;
goto reset2 if $x ne '[';
$row = undef;
row:
sysread STDIN, $x, 1;
if ($x ge '0' && $x le '9') { $row .= $x; goto row }
goto reset2 if $x ne ';';
goto reset1 if !defined $row;
$col = undef;
col:
sysread STDIN, $x, 1;
if ($x ge '0' && $x le '9') { $col .= $x; goto col }
goto reset2 if $x ne 'R';
goto reset1 if !defined $col;

$termios->setlflag($c_lflag);
$termios->setattr(1, TCSANOW);

print "\n" if $col ne '1';
